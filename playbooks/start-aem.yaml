---

- hosts: "tag_Environment_{{Environment}}:&tag_Usage_{{Usage}}:&tag_Role_{{Role}}"
  user: ubuntu
  vars_files:
    - aem-variables.yml
  tasks:

      - name: gather ec2 facts
        action: ec2_metadata_facts

      - name: Obtain EC2 tags
        ec2_tag:
          region: "{{ ansible_ec2_placement_region }}"
          resource: "{{ ansible_ec2_instance_id }}"
          state: list
        delegate_to: localhost
        register: ec2_tags

      - name: Start AEM service
        shell:
          "sudo service {{aem_service_name}} start"
        register: cmdline
        become: true

      - name: Validate Quick Started is completed
        shell:
           "cat {{aem_root_dir}}/crx-quickstart/logs/startup.log | grep '{{aem_startup_complete_msg}}' "
        register: cmdline
        failed_when: "cmdline.rc != 0"
        until: cmdline.rc == 0
        retries: 15
        delay: 10

      - name: Validate all bundles are up
        uri:
          url: http://{{ ansible_ec2_local_ipv4  }}:{{ ec2_tags.tags.AEMPort }}/crx/packmgr/index.jsp
          status_code: "200"
          user: "{{ aem_user_name_ }}{{ ec2_tag_Environment }}"
          password: "{{ aem_user_password_ }}{{ ec2_tag_Environment }}"
        register: response
        until: response.status == 200
        retries: "4"
        delay: "5"
        delegate_to: localhost
