---

- name: " Install AEM packages "
  hosts: "tag_Environment_{{Environment}}:&tag_Usage_{{Usage}}:&tag_Role_{{Role}}"
  user: ubuntu
  vars_files:
    - aem-variables.yml
  tasks:


      - name: gather ec2 facts
        action: ec2_metadata_facts

      - name: Obtain EC2 tags
        ec2_tag:
          region: "{{ ansible_ec2_placement_region }}"
          resource: "{{ ansible_ec2_instance_id }}"
          state: list
          aws_access_key: "{{ ansible_ec2_iam_security_credentials__accesskeyid }}"
          aws_secret_key: "{{ ansible_ec2_iam_security_credentials__secretaccesskey }}"
        delegate_to: localhost
        register: ec2_tags

      - name: " Get list of all packages"
        shell:
          ls -1 {{ deploy_local_folder_packages }}/{{ Environment }}/{{ Usage }}/{{ Role }}
        register: files
        delegate_to: localhost
      - debug: var=files.stdout_lines

      - name: " Install AEM packages "
        shell:
          curl -u 'admin:xt98m34p4kF4q$TB' -F force=true -F install=true -F file=@"{{ deploy_local_folder_packages }}/{{ Environment }}/{{ Usage }}/{{ ec2_tags.tags.Role }}/{{ item }}" http://{{ ansible_ec2_local_ipv4 }}:{{ ec2_tags.tags.AEMPort }}/crx/packmgr/service.jsp | tail -4 | grep 'code="200"'
        delegate_to: localhost
        with_items: "{{ files.stdout_lines }}"
        register: result
      - debug: var=result.stdout_lines
